import storage


def handle_update(text: str) -> str:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ª–æ–≥–∏–∫–∏ –∑–∞–¥–∞—á.
    –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å '/', —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π.
    –ò–Ω–∞—á–µ ‚Äî –æ–±—ã—á–Ω–∞—è –∑–∞–¥–∞—á–∞ –≤ –∏–Ω–±–æ–∫—Å.
    """
    text = (text or "").strip()

    if text.startswith("/"):
        return handle_command(text)
    else:
        return handle_plain_text(text)


def handle_plain_text(text: str) -> str:
    """
    –õ—é–±–æ–µ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã -> –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞.
    """
    if not text:
        return "–ü—É—Å—Ç—É—é –∑–∞–¥–∞—á—É –Ω–µ –¥–æ–±–∞–≤–ª—è—é üôÇ"

    task = storage.add_task(text)
    return f"–î–æ–±–∞–≤–∏–ª–∞ –≤ –∏–Ω–±–æ–∫—Å –∑–∞–¥–∞—á—É #{task['id']}:\n{task['text']}"


def handle_command(text: str) -> str:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ /start, /help, /add, /inbox, /done.
    """
    cmd, *rest = text.split(maxsplit=1)
    arg = rest[0] if rest else ""

    if cmd == "/start":
        return (
            "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –±–æ—Ç-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫.\n\n"
            "–ß—Ç–æ —è —É–∂–µ —É–º–µ—é:\n"
            "‚Ä¢ –ù–∞–ø–∏—à–∏ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –¥–æ–±–∞–≤–ª—é –µ–≥–æ –≤ –∏–Ω–±–æ–∫—Å –∑–∞–¥–∞—á.\n"
            "‚Ä¢ /add –¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ ‚Äî —è–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É.\n"
            "‚Ä¢ /inbox ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á.\n"
            "‚Ä¢ /done N ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ–¥ –Ω–æ–º–µ—Ä–æ–º N –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é."
        )

    if cmd == "/help":
        return (
            "–ö–æ–º–∞–Ω–¥—ã:\n"
            "/add –¢–µ–∫—Å—Ç ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –∏–Ω–±–æ–∫—Å\n"
            "/inbox ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏\n"
            "/done N ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–æ–º–µ—Ä N –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é\n"
            "(–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç ‚Äî —è —Ç–æ–∂–µ –¥–æ–±–∞–≤–ª—é –µ–≥–æ –≤ –∏–Ω–±–æ–∫—Å)"
        )

    if cmd == "/add":
        if not arg.strip():
            return "–ù–∞–ø–∏—à–∏ —Ç–∞–∫: /add –∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"
        task = storage.add_task(arg.strip())
        return f"–î–æ–±–∞–≤–∏–ª–∞ –∑–∞–¥–∞—á—É #{task['id']}:\n{task['text']}"

    if cmd == "/inbox":
        tasks = storage.list_active_tasks()
        if not tasks:
            return "–í –∏–Ω–±–æ–∫—Å–µ –ø—É—Å—Ç–æ ‚ú®"
        lines = [f"{i+1}. {t['text']}" for i, t in enumerate(tasks)]
        return "–¢–≤–æ–π –∏–Ω–±–æ–∫—Å:\n" + "\n".join(lines)

    if cmd == "/done":
        if not arg.strip().isdigit():
            return "–ù–∞–ø–∏—à–∏ —Ç–∞–∫: /done 2 (–Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏ –∏–∑ /inbox)"
        n = int(arg.strip())
        ok, task = storage.complete_task_by_number(n)
        if not ok:
            return "–ù–µ—Ç –∑–∞–¥–∞—á–∏ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –≤ —Å–ø–∏—Å–∫–µ."
        return f"–û—Ç–º–µ—Ç–∏–ª–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é:\n{task['text']}"

    # –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
    return "–Ø –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ù–∞–ø–∏—à–∏ /help."